# 堆内存管理和火车售票算法

还记得12306刚刚上线时候的情景吗？系统处理能力极其有限，买票是一件费时费力的事情，网上一片哗然。有为12306辩护的，也有批评嘲讽的。为之辩护的理由大致是业务量太大，还有冲击性，慢情有可原；批评者认为就是技术能力差，业务量大的理由不成立。

事实上，有算法可以高效地解决售票事务。但这很难向外行解释清楚，就算是一些著名程序员也没有意识到这一点，要么提出了一些错误的建议（如排队系统），要么争论以“你行你上”而告终。

我实际上并不了解12306是如何实现的，因此即便了证明存在高效的售票算法，也不意味着采纳新算法就能提高12306的性能。可是，如果售票核心过程并没有拖累系统性能的话，业务逻辑相似但业务量远超12306的商城网站多得是，12306更没有理由那么慢，反而坐实了是技术能力低下。

要解释这个售票算法是如何工作的，还要从堆内存管理算法说起。

一个稍微像样的程序，就免不了要和堆内存（heap）打交道。可是堆内存管理是怎么实现的呢？传统的有ptmalloc，高性能的有tcmalloc和jemalloc。不过这里不打算讨论他们，二是要介绍它们的前辈，来自早期Unix实现的一个简易的算法，如下图。

![malloc](../.media/images/malloc.jpg "malloc") 
![free](../.media/images/free.jpg "free")